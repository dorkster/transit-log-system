{% extends "base_generic.html" %}

{% block auth_content %}
<style type="text/css">
@media print {
    #print-print, #print-close, #print-filter, #print-filter-hr {
        display: none;
    }
}
body.bg-light {
    background: none !important;
}
nav {
    display: none !important;
}
#notify_vehicle_issues {
    display: none;
}
.footer {
    display: none;
}
#global-notifications {
    display: none !important;
}
</style>
<div class="container-fluid mt-4 mb-3">
    <div class="row">
        <div class="col p-1">
            <h5>Report for: <strong>{{ date_start }} - {{ date_end }}</strong></h5>
        </div>
        <div class="col-auto p-1" id="print-print">
            <a href="#_" class="btn btn-info" onclick="window.print()"><span class="oi oi-print mr-2"></span>Print</a>
        </div>
        <div class="col-auto p-1" id="print-close">
            <a href="#_" class="btn btn-secondary" onclick="window.close()"><span class="oi oi-x mr-2"></span>Close</a>
        </div>
    </div>
</div>
<hr/>
<div>
{% if report_errors.errors %}
<div id="report_errors">
    <div class="row">
        <div class="col">
            <h3>Errors</h3>
        </div>
    </div>
    <div style="max-width: 800px;">
        <ul class="list-group">
        {% for error in report_errors.errors %}
        <li class="list-group-item list-group-item-danger p-2 small">
            <strong class="text-danger">Error:</strong>
            {% if error.error_shift and not error.error_trip %}
                <span class="text-bold">{{ error.error_msg }}</span><br/>
                <div class="mb-2">{{ error.error_shift }}</div>
            {% elif error.error_trip %}
                <span class="text-bold">{{ error.error_msg }}</span><br/>
                <div class="mb-2">{{ error.error_trip }}</div>
            {% else %}
                <span class="text-bold">{{ error.error_msg }}</span><br/>
            {% endif %}
        </li>
        {% endfor %}
        </ul>
    </div>
    <hr/>
</div>
{% endif%}

<div id="report_vehicle_totals">
    <div class="row">
        <div class="col">
            <h3>Totals for All Vehicles</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md"></td>
            <td class="mytable-col-sm">Service Miles</td>
            <td class="mytable-col-sm">Service Hours</td>
            <td class="mytable-col-sm">Deadhead Miles</td>
            <td class="mytable-col-sm">Deadhead Hours</td>
            <td class="mytable-col-sm">Passenger Miles (PMT)</td>
            <td class="mytable-col-sm">Fuel</td>
            {% for key, value in all_vehicles.trip_types.items %}
            <td class="mytable-col-sm">Trip Type: {{key}}</td>
            {% endfor %}
            <td class="mytable-col-sm">Cash Collected</td>
            <td class="mytable-col-sm">Checks Collected</td>
        </thead>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-md">TOTAL</td>
            <td class="mytable-col-sm">{{all_vehicles.service_miles|floatformat:1}}</td>
            <td class="mytable-col-sm">{{all_vehicles.service_hours|floatformat:2}}</td>
            <td class="mytable-col-sm">{{all_vehicles.deadhead_miles|floatformat:1}}</td>
            <td class="mytable-col-sm">{{all_vehicles.deadhead_hours|floatformat:2}}</td>
            <td class="mytable-col-sm">{{all_vehicles.pmt|floatformat:1}}</td>
            <td class="mytable-col-sm">{{all_vehicles.fuel|floatformat:1}}</td>
            {% for key, value in all_vehicles.trip_types.items %}
            <td class="mytable-col-sm">{{value}}</td>
            {% endfor %}
            <td class="mytable-col-sm">{{all_vehicles.collected_cash}}</td>
            <td class="mytable-col-sm">{{all_vehicles.collected_check}}</td>
        </tr>
    </table>
    <hr/>
</div>
{% for v in vehicle_reports %}
<div id="report_vehicle_{{v.vehicle.id}}">
    <div class="row">
        <div class="col">
            <h3>Vehicle: {{v.vehicle}}</h3>
        </div>
    </div>
    {% if v.days %}
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md">Date</td>
            <td class="mytable-col-sm">Service Miles</td>
            <td class="mytable-col-sm">Service Hours</td>
            <td class="mytable-col-sm">Deadhead Miles</td>
            <td class="mytable-col-sm">Deadhead Hours</td>
            <td class="mytable-col-sm">Passenger Miles (PMT)</td>
            <td class="mytable-col-sm">Fuel</td>
            {% for key, value in v.totals.trip_types.items %}
            <td class="mytable-col-sm">Trip Type: {{key}}</td>
            {% endfor %}
            <td class="mytable-col-sm">Cash Collected</td>
            <td class="mytable-col-sm">Checks Collected</td>
        </thead>
        <tbody class="mytable-hoverhi">
            {% for day in v.days %}
            <tr>
                <td class="mytable-col-md"><a href="{% url 'schedule' 'edit' day.date.year day.date.month day.date.day %}">{{day.date}}</a></td>
                <td class="mytable-col-sm {% if day.data.service_miles == 0 %}mytable-zero{%endif%}">{{day.data.service_miles|floatformat:1}}</td>
                <td class="mytable-col-sm {% if day.data.service_hours == 0 %}mytable-zero{%endif%}">{{day.data.service_hours|floatformat:2}}</td>
                <td class="mytable-col-sm {% if day.data.deadhead_miles == 0 %}mytable-zero{%endif%}">{{day.data.deadhead_miles|floatformat:1}}</td>
                <td class="mytable-col-sm {% if day.data.deadhead_hours == 0 %}mytable-zero{%endif%}">{{day.data.deadhead_hours|floatformat:2}}</td>
                <td class="mytable-col-sm {% if day.data.pmt == 0 %}mytable-zero{%endif%}">{{day.data.pmt|floatformat:1}}</td>
                <td class="mytable-col-sm {% if day.data.fuel == 0 %}mytable-zero{%endif%}">{{day.data.fuel|floatformat:1}}</td>
                {% for key, value in day.data.trip_types.items %}
                <td class="mytable-col-sm {% if value == 0 %}mytable-zero{%endif%}">{{value}}</td>
                {% endfor %}
                <td class="mytable-col-sm {% if day.data.collected_cash.value == 0 %}mytable-zero{%endif%}">{{day.data.collected_cash}}</td>
                <td class="mytable-col-sm {% if day.data.collected_check.value == 0 %}mytable-zero{%endif%}">{{day.data.collected_check}}</td>
            </tr>
            {% endfor %}
        </tbody>
        <thead>
            <td class="mytable-col-md">Date</td>
            <td class="mytable-col-sm">Service Miles</td>
            <td class="mytable-col-sm">Service Hours</td>
            <td class="mytable-col-sm">Deadhead Miles</td>
            <td class="mytable-col-sm">Deadhead Hours</td>
            <td class="mytable-col-sm">Passenger Miles (PMT)</td>
            <td class="mytable-col-sm">Fuel</td>
            {% for key, value in v.totals.trip_types.items %}
            <td class="mytable-col-sm">Trip Type: {{key}}</td>
            {% endfor %}
            <td class="mytable-col-sm">Cash Collected</td>
            <td class="mytable-col-sm">Checks Collected</td>
        </thead>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-md">TOTAL</td>
            <td class="mytable-col-sm">{{v.totals.service_miles|floatformat:1}}</td>
            <td class="mytable-col-sm">{{v.totals.service_hours|floatformat:2}}</td>
            <td class="mytable-col-sm">{{v.totals.deadhead_miles|floatformat:1}}</td>
            <td class="mytable-col-sm">{{v.totals.deadhead_hours|floatformat:2}}</td>
            <td class="mytable-col-sm">{{v.totals.pmt|floatformat:1}}</td>
            <td class="mytable-col-sm">{{v.totals.fuel|floatformat:1}}</td>
            {% for key, value in v.totals.trip_types.items %}
            <td class="mytable-col-sm">{{value}}</td>
            {% endfor %}
            <td class="mytable-col-sm">{{v.totals.collected_cash}}</td>
            <td class="mytable-col-sm">{{v.totals.collected_check}}</td>
        </tr>
    </table>
    {% else %}
    <p>No data for this vehicle is available.</p>
    {% endif %}
    <hr/>
</div>
{% endfor %}

{% if unique_riders.names %}
<div id="report_riders">
    <div class="row">
        <div class="col">
            <h3>Elderly/Ambulatory Riders</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md"></td>
            <td class="mytable-col-md text-center">Elderly Ambulatory</td>
            <td class="mytable-col-md text-center">Elderly Non-Ambulatory</td>
            <td class="mytable-col-md text-center">Non-Elderly Ambulatory</td>
            <td class="mytable-col-md text-center">Non-Elderly Non-Ambulatory</td>
            <td class="mytable-col-md text-center">Unknown</td>
            <td class="mytable-col-md text-center">Staff</td>
        </thead>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-md">TOTAL</td>
            <td class="mytable-col-md text-center">{{ unique_riders.elderly_ambulatory }}</td>
            <td class="mytable-col-md text-center">{{ unique_riders.elderly_nonambulatory }}</td>
            <td class="mytable-col-md text-center">{{ unique_riders.nonelderly_ambulatory }}</td>
            <td class="mytable-col-md text-center">{{ unique_riders.nonelderly_nonambulatory }}</td>
            <td class="mytable-col-md text-center">{{ unique_riders.unknown }}</td>
            <td class="mytable-col-md text-center">{{ unique_riders.staff }}</td>
        </tr>
    </table>
    <div class="small text-muted"><em>Staff members are not counted in the elderly/ambulatory totals.</em></div>
    <br/>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-lg">Name</td>
            <td class="mytable-col-sm">Elderly</td>
            <td class="mytable-col-sm">Ambulatory</td>
            <td class="mytable-col-sm">Total Trips</td>
        </thead>
        <tbody class="mytable-hoverhi">
            {% for rider in unique_riders.names %}
            {% if rider.trips > 0 %}
            <tr>
                <td class="mytable-col-lg">
                    <div class="dropdown ajax-blocker">
                        <a href="#_" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{rider.name}}</a>
                        {% if rider.staff %}
                        <span class="badge badge-secondary ml-1">Staff</span>
                        {% endif %}
                        <div class="dropdown-menu shadow">
                            <h5 class="pl-3 pr-3">{{rider.name}}</h5>
                            <div class="dropdown-divider"></div>
                            <a target="_blank" class="dropdown-item" href="{% url 'search' %}?name={{rider.name|urlencode}}&start_date_year={{date_start.year}}&start_date_month={{date_start.month}}&start_date_day={{date_start.day}}&end_date_year={{date_end.year}}&end_date_month={{date_end.month}}&end_date_day={{date_end.day}}">
                                <span class="oi oi-magnifying-glass mr-2"></span>Search for trips<br/><span class="small">From {{date_start}} - {{date_end}}</span>
                            </a>
                            {% if rider.client_id %}
                            <div class="dropdown-divider"></div>
                            <a target="_blank" href="{% url 'client-payments' rider.client_id %}" class="dropdown-item"><span class="oi oi-dollar mr-2"></span>View Client Payments</a>
                            <div class="dropdown-divider"></div>
                            <a target="_blank" class="dropdown-item" href="{% url 'client-edit' rider.client_id %}">
                                <span class="oi oi-person mr-2"></span>Edit Client
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td class="mytable-col-sm">{% if rider.elderly %}<span class="oi oi-check"></span>{% elif rider.elderly == False %}<span class="oi oi-x"></span>{% endif %}</td>
                <td class="mytable-col-sm">{% if rider.ambulatory %}<span class="oi oi-check"></span>{% elif rider.ambulatory == False %}<span class="oi oi-x"></span>{% endif %}</td>
                <td class="mytable-col-sm">{{rider.trips}}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    <hr/>
</div>
{% endif%}

{% if unique_riders.names or money_payments %}
<div id="report_fares">
    <div class="row">
        <div class="col">
            <h3>Fares &amp; Payments</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-lg">Name</td>
            <td class="mytable-col-md">Cash (driver collected)</td>
            <td class="mytable-col-md">Check (driver collected)</td>
            <td class="mytable-col-md">Cash (not driver collected)</td>
            <td class="mytable-col-md">Check (not driver collected)</td>
            <td class="mytable-col-md">Total Payments</td>
            <td class="mytable-col-md">Total Fares</td>
            <td class="mytable-col-md">Total Owed</td>
        </thead>
        <tbody class="mytable-hoverhi">
            {% for rider in unique_riders.names %}
            {% if rider.total_payments.value > 0 or rider.total_fares.value > 0 %}
            <tr>
                <td class="mytable-col-lg">
                    <div class="dropdown ajax-blocker">
                        <a href="#_" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{rider.name}}</a>
                        <div class="dropdown-menu shadow">
                            <h5 class="pl-3 pr-3">{{rider.name}}</h5>
                            <div class="dropdown-divider"></div>
                            <a target="_blank" class="dropdown-item" href="{% url 'search' %}?name={{rider.name|urlencode}}&start_date_year={{date_start.year}}&start_date_month={{date_start.month}}&start_date_day={{date_start.day}}&end_date_year={{date_end.year}}&end_date_month={{date_end.month}}&end_date_day={{date_end.day}}">
                                <span class="oi oi-magnifying-glass mr-2"></span>Search for trips<br/><span class="small">From {{date_start}} - {{date_end}}</span>
                            </a>
                            {% if rider.client_id %}
                            <div class="dropdown-divider"></div>
                            <a target="_blank" href="{% url 'client-payments' rider.client_id %}" class="dropdown-item"><span class="oi oi-dollar mr-2"></span>View Client Payments</a>
                            <div class="dropdown-divider"></div>
                            <a target="_blank" class="dropdown-item" href="{% url 'client-edit' rider.client_id %}">
                                <span class="oi oi-person mr-2"></span>Edit Client
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td class="mytable-col-md {% if rider.collected_cash.value == 0 %}mytable-zero{%endif%}">{{ rider.collected_cash }}</td>
                <td class="mytable-col-md {% if rider.collected_check.value == 0 %}mytable-zero{%endif%}">{{ rider.collected_check }}</td>
                <td class="mytable-col-md {% if rider.paid_cash.value == 0 %}mytable-zero{%endif%}">{{ rider.paid_cash }}</td>
                <td class="mytable-col-md {% if rider.paid_check.value == 0 %}mytable-zero{%endif%}">{{ rider.paid_check }}</td>
                <td class="mytable-col-md {% if rider.total_payments.value == 0 %}mytable-zero{%endif%}">{{ rider.total_payments }}</td>
                <td class="mytable-col-md {% if rider.total_fares.value == 0 %}mytable-zero{%endif%}">{{ rider.total_fares }}</td>
                <td class="mytable-col-md {% if rider.total_owed.value == 0 %}mytable-zero{%endif%}">{{ rider.total_owed }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-lg">TOTAL</td>
            <td class="mytable-col-md">{{ unique_riders.total_collected_cash }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_collected_check }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_paid_cash }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_paid_check }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_total_payments }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_total_fares }}</td>
            <td class="mytable-col-md">{{ unique_riders.total_total_owed }}</td>
        </tr>
    </table>
    <hr/>
</div>
{% endif %}

{% if money_trips %}
<div id="report_collected_money">
    <div class="row">
        <div class="col">
            <h3>Money Collected by the Drivers</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md">Date</td>
            <td class="mytable-col-lg">Name</td>
            <td class="mytable-col-sm">Cash</td>
            <td class="mytable-col-sm">Check</td>
        </thead>
        <tbody class="mytable-hoverhi">
            {% for money_trip in money_trips %}
            <tr>
                <td class="mytable-col-md"><a href="{% url 'trip-edit' 'edit' money_trip.trip.id %}">{{ money_trip.trip.date }}</a></td>
                <td class="mytable-col-lg">{{ money_trip.trip.name }}</td>
                <td class="mytable-col-sm {% if money_trip.collected_cash.value == 0 %}mytable-zero{%endif%}">{{ money_trip.collected_cash}}</td>
                <td class="mytable-col-sm {% if money_trip.collected_check.value == 0 %}mytable-zero{%endif%}">{{ money_trip.collected_check}}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-md">TOTAL</td>
            <td class="mytable-col-lg"></td>
            <td class="mytable-col-sm">{{ money_trips_summary.collected_cash}}</td>
            <td class="mytable-col-sm">{{ money_trips_summary.collected_check}}</td>
        </tr>
    </table>
    <hr/>
</div>
{% endif %}

{% if money_payments %}
<div id="report_payments">
    <div class="row">
        <div class="col">
            <h3>Money Not Collected by the Drivers</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md">Date</td>
            <td class="mytable-col-lg">Name</td>
            <td class="mytable-col-sm">Cash</td>
            <td class="mytable-col-sm">Check</td>
        </thead>
        <tbody class="mytable-hoverhi">
            {% for money_payment in money_payments %}
            <tr>
                <td class="mytable-col-md"><a href="{% url 'client-payment-edit' money_payment.client.id money_payment.id %}">{{ money_payment.date }}</a></td>
                <td class="mytable-col-lg">{{ money_payment.client.name }}</td>
                <td class="mytable-col-sm {% if money_payment.cash.value == 0 %}mytable-zero{%endif%}">{{ money_payment.cash}}</td>
                <td class="mytable-col-sm {% if money_payment.check.value == 0 %}mytable-zero{%endif%}">{{ money_payment.check}}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tr class="bg-success text-light text-bold">
            <td class="mytable-col-md">TOTAL</td>
            <td class="mytable-col-lg"></td>
            <td class="mytable-col-sm">{{ money_payments_summary.cash}}</td>
            <td class="mytable-col-sm">{{ money_payments_summary.check}}</td>
        </tr>
    </table>
    <hr/>
</div>
{% endif %}

{% if driver_reports %}
<div id="report_drivers">
    <div class="row">
        <div class="col">
            <h3>Per-Driver Summary</h3>
        </div>
    </div>
    <table class="mytable mytable-striped">
        <thead>
            <td class="mytable-col-md">Driver</td>
            <td class="mytable-col-sm">Service Miles</td>
            <td class="mytable-col-sm">Service Hours</td>
            <td class="mytable-col-sm">Deadhead Miles</td>
            <td class="mytable-col-sm">Deadhead Hours</td>
            <td class="mytable-col-sm">Total Miles</td>
            <td class="mytable-col-sm">Total Hours</td>
        </thead>
        {% for d in driver_reports %}
        <tr style="background: #{{d.driver.get_color}}">
            <td class="mytable-col-md">{{d.driver}}</td>
            <td class="mytable-col-sm {% if d.totals.service_miles == 0 %}mytable-zero{%endif%}">{{d.totals.service_miles|floatformat:1}}</td>
            <td class="mytable-col-sm {% if d.totals.service_hours == 0 %}mytable-zero{%endif%}">{{d.totals.service_hours|floatformat:2}}</td>
            <td class="mytable-col-sm {% if d.totals.deadhead_miles == 0 %}mytable-zero{%endif%}">{{d.totals.deadhead_miles|floatformat:1}}</td>
            <td class="mytable-col-sm {% if d.totals.deadhead_hours == 0 %}mytable-zero{%endif%}">{{d.totals.deadhead_hours|floatformat:2}}</td>
            <td class="mytable-col-sm {% if d.totals.total_miles == 0 %}mytable-zero{%endif%}">{{d.totals.total_miles|floatformat:1}}</td>
            <td class="mytable-col-sm {% if d.totals.total_hours == 0 %}mytable-zero{%endif%}">{{d.totals.total_hours|floatformat:2}}</td>
        </tr>
        {% endfor %}
    </table>
    <hr/>
</div>
{% endif %}
</div>
{% block javascript %}
<script type="text/javascript">
    window.print();

    // set up the visibility array
    var visible = [];
    var visible_count = 7 + {{vehicles.count}};
    // value (1 = visible), div id, checkbox id
    visible.push([1, "#report_errors", "#vis_errors"]);
    visible.push([1, "#report_vehicle_totals", "#vis_vehicle_totals"]);
    {% for v in vehicles %}
    visible.push([1, "#report_vehicle_{{v.id}}", "#vis_vehicle_{{v.id}}"]);
    {% endfor %}
    visible.push([1, "#report_riders", "#vis_riders"]);
    visible.push([1, "#report_fares", "#vis_fares"]);
    visible.push([1, "#report_collected_money", "#vis_collected_money"]);
    visible.push([1, "#report_payments", "#vis_payments"]);
    visible.push([1, "#report_drivers", "#vis_drivers"]);

    visibleLoad();

    function visibleLoad() {
        var cookie_str = cookieRead("report_visibility");

        for (i = 0; i < visible_count; i++) {
            visible[i][0] = 1;
        }
        for (i = 0; i < cookie_str.length; i++) {
            visible[i][0] = parseInt(cookie_str.charAt(i));
        }

        visibleApply();
    }

    function visibleApply() {
        var show_all_btn = false;

        for (i = 0; i < visible_count; i++) {
            if ($(visible[i][1]).length) {
                if (visible[i][0] == 1) {
                    $(visible[i][2]).prop("checked", true);
                    $(visible[i][1]).removeClass("d-none");
                }
                else {
                    $(visible[i][2]).prop("checked", false);
                    $(visible[i][1]).addClass("d-none");
                    show_all_btn = true;
                }
            }
        }

        if (show_all_btn == true) {
            $("#vis_all").removeClass("d-none");
        }
        else {
            $("#vis_all").addClass("d-none");
        }
    }
</script>
{% endblock %}
{% endblock %}

{% block content %}
<p>You are not authorized. Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a>.</p>
{% endblock %}
