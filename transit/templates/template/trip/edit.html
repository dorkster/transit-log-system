{% extends "base_generic.html" %}

{% block auth_content %}
{% load static %}
<h2>
    {% if is_new %}
    New {% if trip.is_activity %}Activity{% else %}Trip{% endif %} Template
    {% else %}
    {% if trip.is_activity %}Activity{% else %}Trip{% endif %} Template Edit
    {% endif %}
</h2>
<form class="mb-4" action="" method="post" onsubmit="return checkForm(this, event);">
    {% csrf_token %}
    <datalist id='client-names'>
        {% for client in clients %}
        <option value="{{ client.name }}">
        {% endfor %}
    </datalist>
    <datalist id='addresses'>
        {% if destinations|length_is:"0" %}
        {% for address in addresses %}
        <option value="{{ address }}">
        {% endfor %}
        {% else %}
        <option value="">
        {% for destination in destinations %}
        <option value="{{ destination.address }}">
        {% endfor %}
        {% endif %}
    </datalist>
    <div class="container ml-0">
        <div class="row">
            <div class="col border m-1 pt-1">
                <fieldset class="form-group">
                    <legend>{{ form.parent.label }}</legend>
                    <div>{{ form.parent }}</div>
                </fieldset>
            </div>
        </div>
        <div class="row">
            {% if trip.is_activity %}
            <div class="col border m-1 pt-1">
                <fieldset class="form-group">
                    <legend>Activity Information</legend>
                    <div class="mb-2"><label for="{{ form.start_time.id_for_label }}"><strong>{{ form.start_time.label }}</strong></label><br/>{{ form.start_time }}</div>
                    <div class="mb-2"><label for="{{ form.end_time.id_for_label }}"><strong>{{ form.end_time.label }}</strong></label><br/>{{ form.end_time }}</div>
                    <div class="mb-2"><label for="{{ form.description.id_for_label }}"><strong>{{ form.description.label }}</strong></label><br/>{{ form.description }}</div>
                </fieldset>
            </div>
            {% else %}
            <div class="col border m-1 pt-1">
                <fieldset class="form-group">
                    <legend>Client Information</legend>
                    <div class="mb-2"><label for="{{ form.name.id_for_label }}"><strong>{{ form.name.label }}</strong></label><br/>{{ form.name }}</div>
                    <div class="mb-2"><label for="{{ form.phone_home.id_for_label }}"><strong>{{ form.phone_home.label }}</strong></label>
                        <a title="Get the client's home phone number" href="#_" class="btn btn-secondary btn-sm ml-2" onclick="getClientPhone('id_phone_home', 'home')"><span class="oi oi-phone"></span></a>
                        <br/>{{ form.phone_home }}
                    </div>
                    <div class="mb-2"><label for="{{ form.phone_cell.id_for_label }}"><strong>{{ form.phone_cell.label }}</strong></label>
                        <a title="Get the client's cell phone number" href="#_" class="btn btn-secondary btn-sm ml-2" onclick="getClientPhone('id_phone_cell', 'cell')"><span class="oi oi-phone"></span></a>
                        <br/>{{ form.phone_cell }}
                    </div>
                    <hr/>
                    <div class="mb-2"><label for="{{ form.elderly.id_for_label }}"><strong>{{ form.elderly.label }}</strong></label><br/>{{ form.elderly }}</div>
                    <div class="mb-2"><label for="{{ form.ambulatory.id_for_label }}"><strong>{{ form.ambulatory.label }}</strong></label><br/>{{ form.ambulatory }}</div>
                    <hr/>
                    <div class="mb-2"><label for="{{ form.notes.id_for_label }}"><strong>{{ form.notes.label }}</strong></label><br/>{{ form.notes }}</div>
                </fieldset>
            </div>
            <div class="col border m-1 pt-1">
                <fieldset class="form-group">
                    <legend>Trip Information</legend>
                    <div class="mb-2"><label for="{{ form.pick_up_time.id_for_label }}"><strong>{{ form.pick_up_time.label }}</strong></label><br/>{{ form.pick_up_time }}</div>
                    <div class="mb-2"><label for="{{ form.appointment_time.id_for_label }}"><strong>{{ form.appointment_time.label }}</strong></label><br/>{{ form.appointment_time }}</div>
                    <hr/>
                    <div class="mb-2"><label for="{{ form.address.id_for_label }}"><strong>{{ form.address.label }}</strong></label>
                        <a href="#_" class="btn btn-sm btn-secondary ml-2" title="Get the client's home address" onclick="getClientAddress('id_address', 'id_phone_address')"><span class="oi oi-home"></span></a>
                        <br/>{{ form.address }}</div>
                    <div class="mb-2"><label for="{{ form.phone_address.id_for_label }}"><strong>{{ form.phone_address.label }}</strong></label>
                        <a title="Get the pick-up phone number" href="#_" class="btn btn-secondary btn-sm ml-2" onclick="getDestinationPhone('id_address', 'id_phone_address')"><span class="oi oi-phone"></span></a>
                        <br/>{{ form.phone_address }}
                    </div>
                    <hr/>
                    <div class="mb-2"><label for="{{ form.destination.id_for_label }}"><strong>{{ form.destination.label }}</strong></label>
                        <a href="#_" class="btn btn-sm btn-secondary ml-2" title="Get the client's home address" onclick="getClientAddress('id_destination', 'id_phone_destination')"><span class="oi oi-home"></span></a>
                        <br/>{{ form.destination }}</div>
                    <div class="mb-2"><label for="{{ form.phone_destination.id_for_label }}"><strong>{{ form.phone_destination.label }}</strong></label>
                        <a title="Get the destination phone number" href="#_" class="btn btn-secondary btn-sm ml-2" onclick="getDestinationPhone('id_destination', 'id_phone_destination')"><span class="oi oi-phone"></span></a>
                        <br/>{{ form.phone_destination }}
                    </div>
                    <hr/>
                    <div class="mb-2"><label for="{{ form.trip_type.id_for_label }}"><strong>{{ form.trip_type.label }}</strong></label><br/>{{ form.trip_type }}</div>
                    <div class="mb-2"><label for="{{ form.tags.id_for_label }}"><strong>{{ form.tags.label }}</strong></label><br/>{{ form.tags }}
                        {% if frequent_tags %}
                        <br/><span class="text-muted">Frequently used: </span>
                        {% for tag in frequent_tags %}
                        <span><a class="badge {{ tag.getStyle }}" href="#_" onclick="addFrequentTag('{{tag.tag}}')"><span class="oi oi-tag mr-1"></span>{{tag.tag}}</a> </span>
                        <script type="text/javascript">
                            function addFrequentTag(tag) {
                                if ($('#id_tags').val() == "") {
                                    $('#id_tags').val(tag);
                                    return;
                                }

                                var split_tags = $('#id_tags').val().split(',');
                                for (i in split_tags) {
                                    if ($.trim(split_tags[i]) == tag)
                                        return;
                                }

                                $('#id_tags').val($('#id_tags').val() + (", " + tag));
                            }
                        </script>
                        {% endfor %}
                        {% endif %}
                    </div>
                </fieldset>
            </div>
            <div class="col border m-1 pt-1">
                <fieldset class="form-group">
                    <legend>Log Information</legend>
                    <div class="mb-2"><label for="{{ form.driver.id_for_label }}"><strong>{{ form.driver.label }}</strong></label><br/>{{ form.driver }}</div>
                    <div class="mb-2"><label for="{{ form.vehicle.id_for_label }}"><strong>{{ form.vehicle.label }}</strong></label><br/>{{ form.vehicle }}</div>
                </fieldset>
            </div>
            {% endif %}
        </div>
        <hr>
        <div class="d-flex flex-wrap mt-2">
            <div class="mr-auto mb-3">
                <button class="btn btn-success btn-lg m-2" type="submit" name="save"><span class="oi oi-check mr-2"></span>Save Changes</button>
                <button class="btn btn-secondary btn-lg m-2" type="submit" name="cancel" formnovalidate><span class="oi oi-x mr-2"></span>Cancel Changes</button>
            </div>
            {% if not is_new %}
            <div>
                <button class="btn btn-danger btn-lg m-2" type="submit" name="delete" formnovalidate><span class="oi oi-delete mr-2"></span>Delete {{trip.get_class_name}}</button>
            </div>
            {% endif %}
        </div>
    </div>
</form>
{% block javascript %}
<script type="text/javascript" src="{% static 'js/validate.js' %}"></script>
{{ clients_json|json_script:"clients-tag" }}
{{ destinations_json|json_script:"destinations-tag" }}
<script type="text/javascript">
    focusFromParam();

{% if not trip.is_activity %}
    var clients = JSON.parse(JSON.parse(document.getElementById("clients-tag").textContent));

    var name_input = document.getElementById("id_name");
    function onNameChanged() {
        var address_datalist = document.getElementById("addresses");
        address_datalist.children[0].value = "";

        for (i in clients) {
            if (clients[i].fields.name == name_input.value) {
                var phone_home_input = document.getElementById("id_phone_home");
                phone_home_input.value = clients[i].fields.phone_home;
                var phone_cell_input = document.getElementById("id_phone_cell");
                phone_cell_input.value = clients[i].fields.phone_cell;

                var elderly_input = document.getElementById("id_elderly");
                if (clients[i].fields.elderly == null)
                    elderly_input.selectedIndex = 0;
                else if (clients[i].fields.elderly == true)
                    elderly_input.selectedIndex = 1;
                else if (clients[i].fields.elderly == false)
                    elderly_input.selectedIndex = 2;

                var ambulatory_input = document.getElementById("id_ambulatory");
                if (clients[i].fields.ambulatory == null)
                    ambulatory_input.selectedIndex = 0;
                else if (clients[i].fields.ambulatory == true)
                    ambulatory_input.selectedIndex = 1;
                else if (clients[i].fields.ambulatory == false)
                    ambulatory_input.selectedIndex = 2;

                var tags_input = document.getElementById("id_tags");
                tags_input.value = clients[i].fields.tags;

                address_datalist.children[0].value = clients[i].fields.address;
                break;
            }
        }
    }
    name_input.addEventListener("change", onNameChanged);

    function getClientPhone(input, phone_type) {
        $("#" + input).val("");
        for (i in clients) {
            if (clients[i].fields.name == name_input.value) {
                if (phone_type == "home")
                    $("#" + input).val(clients[i].fields.phone_home);
                else if (phone_type == "cell")
                    $("#" + input).val(clients[i].fields.phone_cell);

                break;
            }
        }
    }

    function getClientAddress(address_input, phone_input) {
        $("#" + address_input).val("");
        $("#" + phone_input).val("");
        for (i in clients) {
            if (clients[i].fields.name == name_input.value) {
                $("#" + address_input).val(clients[i].fields.address);
            }
        }
    }

    var destinations = JSON.parse(JSON.parse(document.getElementById("destinations-tag").textContent));

    var pickup_input = document.getElementById("id_address");
    var destination_input = document.getElementById("id_destination");
    function onAddressChanged(address_input, phone_input) {
        for (i in destinations) {
            if (destinations[i].fields.address == address_input.value) {
                phone_input.value = destinations[i].fields.phone;
                break;
            }
        }
    }

    function getDestinationPhone(address_input, phone_input) {
        $("#" + phone_input).val("");
        for (i in destinations) {
            if (destinations[i].fields.address == $("#" + address_input).val()) {
                $("#" + phone_input).val(destinations[i].fields.phone);
                break;
            }
        }
    }

    var pickup_phone_input = document.getElementById("id_phone_address");
    var destination_phone_input = document.getElementById("id_phone_destination");
    pickup_input.addEventListener("change", function() { onAddressChanged(this, pickup_phone_input); });
    destination_input.addEventListener("change", function() { onAddressChanged(this, destination_phone_input); });
{% endif %}
</script>
{% endblock %}
{% endblock %}

{% block content %}
<p>You are not authorized. Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a>.</p>
{% endblock %}
