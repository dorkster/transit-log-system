{% extends "base_generic.html" %}

{% block auth_content %}
<div class="container-fluid mt-4 mb-3">
    <div class="row">
        <div class="col p-1">
            <h5>Report for: <strong>{{ date_start }} - {{ date_end }}</strong></h5>
        </div>
        <div class="col-auto p-1">
            <a class="btn btn-primary" href="{% url 'report-xlsx' date_start.year date_start.month date_start.day date_end.year date_end.month date_end.day %}"><span class="oi oi-data-transfer-download mr-2"></span>Download as Excel</a>
        </div>
        <div class="col-sm-auto p-1">
            <div class="btn-group" role="group">
                <a title="Previous month" class="btn btn-secondary" href="{{ month_prev }}">
                    <span class="oi oi-chevron-left"></span>
                </a>
                <div class="btn-group" role="group" id="date_dropdown">
                    <button title="Select a month" class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="oi oi-calendar"></span>
                    </button>
                    <div class="dropdown-menu shadow dropdown-menu-right">
                        <div class="p-2" style="white-space: nowrap;">
                            <form action="" method="post" class="date-picker">
                                {% csrf_token %}
                                {{ date_picker }}
                                <input type="submit" value="Go" class="btn btn-secondary align-top">
                            </form>
                        </div>
                        <a class="dropdown-item" href="{% url 'report-this-month' %}">Go to this month</a>
                        <div class="dropdown-divider"></div>
                        <div class="p-2 small"><strong>Custom Date Range</strong></div>
                        <div class="p-2" style="white-space: nowrap;">
                            <form action="" method="post" class="date-picker">
                                {% csrf_token %}
                                <div class="mb-2">
                                    {{ date_range_picker.date_start }}
                                </div>
                                <div class="mb-2">
                                    {{ date_range_picker.date_end }}
                                </div>
                                <div>
                                    <button class="btn btn-secondary align-top w-100" type="submit" name="date_range">Go</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <a title="Next month" class="btn btn-secondary" href="{{ month_next }}">
                    <span class="oi oi-chevron-right"></span>
                </a>
            </div>
            <script type="text/javascript">
                // Keep the dropdown from closing when picking a date
                $('#date_dropdown option, #date_dropdown select').click(function(e) {
                    e.stopPropagation();
                });
                $("#id_date_day").attr("style", "display: none !important;");
            </script>
        </div>
    </div>
</div>
<hr/>
<div>
{% if report_errors.errors %}
<h3>Errors</h3>
<div style="max-width: 800px;">
    <ul class="list-group">
    {% for error in report_errors.errors %}
    <li class="list-group-item list-group-item-danger p-2 small">
        <strong class="text-danger">Error:</strong>
        {% if error.error_code == 0 %}
            <span class="text-bold">Shift contains partial log data.</span><br/>
            <div class="mb-2">{{ error.error_shift }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#shift_{{ error.error_shift.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'shift-edit' 'edit' error.error_shift.id %}">Edit Shift</a>
        {% elif error.error_code == 1 %}
            <span class="text-bold">Trip contains partial log data.</span><br/>
            <div class="mb-2">{{ error.error_trip }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#trip_{{ error.error_trip.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'trip-edit' 'edit' error.error_trip.id %}">Edit Trip</a>
        {% elif error.error_code == 2 %}
            <span class="text-bold">Trip does not have a matching Shift.</span><br/>
            <div class="mb-2">{{ error.error_trip }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#trip_{{ error.error_trip.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'trip-edit' 'edit' error.error_trip.id %}">Edit Trip</a>
        {% elif error.error_code == 3 %}
            <span class="text-bold">Trip mileage is not within Shift mileage.</span><br/>
            <div class="mb-2">{{ error.error_trip }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#trip_{{ error.error_trip.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'trip-edit' 'edit' error.error_trip.id %}">Edit Trip</a>
        {% elif error.error_code == 4 %}
            <span class="text-bold">Trip time is not within Shift time.</span><br/>
            <div class="mb-2">{{ error.error_trip }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#trip_{{ error.error_trip.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'trip-edit' 'edit' error.error_trip.id %}">Edit Trip</a>
        {% elif error.error_code == 5 %}
            <span class="text-bold">Unable to parse Shift data.</span><br/>
            <div class="mb-2">{{ error.error_shift }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#shift_{{ error.error_shift.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'shift-edit' 'edit' error.error_shift.id %}">Edit Shift</a>
        {% elif error.error_code == 6 %}
            <span class="text-bold">Unable to parse Trip data.</span><br/>
            <div class="mb-2">{{ error.error_trip }}</div>
            <a class="btn btn-sm btn-danger" href="{% url 'schedule' 'edit' error.date.year error.date.month error.date.day %}#trip_{{ error.error_trip.id }}">View on schedule</a>
            <a class="btn btn-sm btn-danger" href="{% url 'trip-edit' 'edit' error.error_trip.id %}">Edit Trip</a>
        {% endif %}
    </li>
    {% endfor %}
    </ul>
</div>
<hr/>
{% endif%}

<h3>Totals for All Vehicles</h3>
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-md"></td>
        <td class="mytable-col-sm">Service Miles</td>
        <td class="mytable-col-sm">Service Hours</td>
        <td class="mytable-col-sm">Deadhead Miles</td>
        <td class="mytable-col-sm">Deadhead Hours</td>
        <td class="mytable-col-sm">Passenger Miles (PMT)</td>
        <td class="mytable-col-sm">Fuel</td>
        {% for key, value in all_vehicles.trip_types.items %}
        <td class="mytable-col-sm">Trip Type: {{key}}</td>
        {% endfor %}
        <td class="mytable-col-sm">Cash Collected</td>
        <td class="mytable-col-sm">Checks Collected</td>
    </thead>
    <tr class="bg-success text-light text-bold">
        <td class="mytable-col-md">TOTAL</td>
        <td class="mytable-col-sm">{{all_vehicles.service_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{all_vehicles.service_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{all_vehicles.deadhead_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{all_vehicles.deadhead_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{all_vehicles.pmt|floatformat:1}}</td>
        <td class="mytable-col-sm">{{all_vehicles.fuel|floatformat:1}}</td>
        {% for key, value in all_vehicles.trip_types.items %}
        <td class="mytable-col-sm">{{value}}</td>
        {% endfor %}
        <td class="mytable-col-sm">{{all_vehicles.collected_cash}}</td>
        <td class="mytable-col-sm">{{all_vehicles.collected_check}}</td>
    </tr>
</table>
<hr/>
{% for v in vehicle_reports %}
<h3>Vehicle: {{v.vehicle}}</h3>
{% if v.days %}
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-md">Date</td>
        <td class="mytable-col-sm">Service Miles</td>
        <td class="mytable-col-sm">Service Hours</td>
        <td class="mytable-col-sm">Deadhead Miles</td>
        <td class="mytable-col-sm">Deadhead Hours</td>
        <td class="mytable-col-sm">Passenger Miles (PMT)</td>
        <td class="mytable-col-sm">Fuel</td>
        {% for key, value in v.totals.trip_types.items %}
        <td class="mytable-col-sm">Trip Type: {{key}}</td>
        {% endfor %}
        <td class="mytable-col-sm">Cash Collected</td>
        <td class="mytable-col-sm">Checks Collected</td>
    </thead>
    {% for day in v.days %}
    <tr>
        <td class="mytable-col-md"><a href="{% url 'schedule' 'edit' day.date.year day.date.month day.date.day %}">{{day.date}}</a></td>
        <td class="mytable-col-sm">{{day.data.service_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{day.data.service_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{day.data.deadhead_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{day.data.deadhead_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{day.data.pmt|floatformat:1}}</td>
        <td class="mytable-col-sm">{{day.data.fuel|floatformat:1}}</td>
        {% for key, value in day.data.trip_types.items %}
        <td class="mytable-col-sm">{{value}}</td>
        {% endfor %}
        <td class="mytable-col-sm">{{day.data.collected_cash}}</td>
        <td class="mytable-col-sm">{{day.data.collected_check}}</td>
    </tr>
    {% endfor %}
    <thead>
        <td class="mytable-col-md">Date</td>
        <td class="mytable-col-sm">Service Miles</td>
        <td class="mytable-col-sm">Service Hours</td>
        <td class="mytable-col-sm">Deadhead Miles</td>
        <td class="mytable-col-sm">Deadhead Hours</td>
        <td class="mytable-col-sm">Passenger Miles (PMT)</td>
        <td class="mytable-col-sm">Fuel</td>
        {% for key, value in v.totals.trip_types.items %}
        <td class="mytable-col-sm">Trip Type: {{key}}</td>
        {% endfor %}
        <td class="mytable-col-sm">Cash Collected</td>
        <td class="mytable-col-sm">Checks Collected</td>
    </thead>
    <tr class="bg-success text-light text-bold">
        <td class="mytable-col-md">TOTAL</td>
        <td class="mytable-col-sm">{{v.totals.service_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{v.totals.service_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{v.totals.deadhead_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{v.totals.deadhead_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{v.totals.pmt|floatformat:1}}</td>
        <td class="mytable-col-sm">{{v.totals.fuel|floatformat:1}}</td>
        {% for key, value in v.totals.trip_types.items %}
        <td class="mytable-col-sm">{{value}}</td>
        {% endfor %}
        <td class="mytable-col-sm">{{v.totals.collected_cash}}</td>
        <td class="mytable-col-sm">{{v.totals.collected_check}}</td>
    </tr>
</table>
{% else %}
<p>No data for this vehicle is available.</p>
{% endif %}
<hr/>
{% endfor %}

{% if unique_riders.names %}
<h3>Elderly/Ambulatory Riders</h3>
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-md"></td>
        <td class="mytable-col-md text-center">Elderly Ambulatory</td>
        <td class="mytable-col-md text-center">Elderly Non-Ambulatory</td>
        <td class="mytable-col-md text-center">Non-Elderly Ambulatory</td>
        <td class="mytable-col-md text-center">Non-Elderly Non-Ambulatory</td>
        <td class="mytable-col-md text-center">Unknown</td>
    </thead>
    <tr class="bg-success text-light text-bold">
        <td class="mytable-col-md">TOTAL</td>
        <td class="mytable-col-md text-center">{{ unique_riders.elderly_ambulatory }}</td>
        <td class="mytable-col-md text-center">{{ unique_riders.elderly_nonambulatory }}</td>
        <td class="mytable-col-md text-center">{{ unique_riders.nonelderly_ambulatory }}</td>
        <td class="mytable-col-md text-center">{{ unique_riders.nonelderly_nonambulatory }}</td>
        <td class="mytable-col-md text-center">{{ unique_riders.unknown }}</td>
    </tr>
</table>
<br/>
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-lg">Name</td>
        <td class="mytable-col-sm">Elderly</td>
        <td class="mytable-col-sm">Ambulatory</td>
        <td class="mytable-col-sm">Total Trips</td>
    </thead>
    {% for rider in unique_riders.names %}
    <tr>
        <td class="mytable-col-lg">
            <a href="{% url 'search' %}?name={{rider.name|urlencode}}&start_date_year={{date_start.year}}&start_date_month={{date_start.month}}&start_date_day={{date_start.day}}&end_date_year={{date_end.year}}&end_date_month={{date_end.month}}&end_date_day={{date_end.day}}">
                {{rider.name}}
            </a>
        </td>
        <td class="mytable-col-sm">{% if rider.elderly %}<span class="oi oi-check"></span>{% elif rider.elderly == False %}<span class="oi oi-x"></span>{% endif %}</td>
        <td class="mytable-col-sm">{% if rider.ambulatory %}<span class="oi oi-check"></span>{% elif rider.ambulatory == False %}<span class="oi oi-x"></span>{% endif %}</td>
        <td class="mytable-col-sm">{{rider.trips}}</td>
    </tr>
    {% endfor %}
</table>
<hr/>
{% endif%}

{% if money_trips %}
<h3>Money Collected</h3>
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-md">Date</td>
        <td class="mytable-col-lg">Name</td>
        <td class="mytable-col-sm">Cash</td>
        <td class="mytable-col-sm">Check</td>
    </thead>
    {% for money_trip in money_trips %}
    <tr>
        <td class="mytable-col-md"><a href="{% url 'trip-edit' 'edit' money_trip.trip.id %}">{{ money_trip.trip.date }}</a></td>
        <td class="mytable-col-lg">{{ money_trip.trip.name }}</td>
        <td class="mytable-col-sm">{{ money_trip.collected_cash}}</td>
        <td class="mytable-col-sm">{{ money_trip.collected_check}}</td>
    </tr>
    {% endfor %}
    <tr class="bg-success text-light text-bold">
        <td class="mytable-col-md">TOTAL</td>
        <td class="mytable-col-lg"></td>
        <td class="mytable-col-sm">{{ money_trips_summary.collected_cash}}</td>
        <td class="mytable-col-sm">{{ money_trips_summary.collected_check}}</td>
    </tr>
</table>
<hr/>
{% endif %}

{% if driver_reports %}
<h3>Per-Driver Summary</h3>
<table class="mytable mytable-striped">
    <thead>
        <td class="mytable-col-md">Driver</td>
        <td class="mytable-col-sm">Service Miles</td>
        <td class="mytable-col-sm">Service Hours</td>
        <td class="mytable-col-sm">Deadhead Miles</td>
        <td class="mytable-col-sm">Deadhead Hours</td>
        <td class="mytable-col-sm">Total Miles</td>
        <td class="mytable-col-sm">Total Hours</td>
    </thead>
    {% for d in driver_reports %}
    <tr style="background: #{{d.driver.get_color}}">
        <td class="mytable-col-md">{{d.driver}}</td>
        <td class="mytable-col-sm">{{d.totals.service_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{d.totals.service_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{d.totals.deadhead_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{d.totals.deadhead_hours|floatformat:2}}</td>
        <td class="mytable-col-sm">{{d.totals.total_miles|floatformat:1}}</td>
        <td class="mytable-col-sm">{{d.totals.total_hours|floatformat:2}}</td>
    </tr>
    {% endfor %}
</table>
<hr/>
{% endif %}
</div>
{% endblock %}

{% block content %}
<p>You are not authorized. Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a>.</p>
{% endblock %}
